<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Job Parser) v15.1 - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* ------------------- STYLES (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ------------------- */
:root {
    --primary-color: #007bff;
    --secondary-color: #28a745;
    --background-light: #f7f7f7;
    --background-white: #ffffff;
    --text-color: #333;
    --border-radius: 8px;
}
body {
    font-family: 'Kanit', sans-serif;
    background: var(--background-light);
    padding: 20px;
    color: var(--text-color);
    max-width: 1200px;
    margin: 0 auto;
}
h1 {
    color: var(--primary-color);
    font-weight: 700;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 3px solid var(--primary-color);
    display: inline-block;
}
h2 {
    color: #495057;
    font-weight: 600;
    margin-top: 20px;
    margin-bottom: 10px;
}
.input-section {
    display: flex;
    flex-direction: column;
}
.input-control-wrapper {
    display: flex;
    gap: 15px;
    align-items: flex-end;
}
.input-control-wrapper textarea {
    flex-grow: 1;
    width: 100%;
}
.control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 15px;
    flex-shrink: 0;
}
textarea {
    height: 200px;
    font-family: 'Kanit', monospace;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: var(--border-radius);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
    resize: vertical;
}
button {
    padding: 8px 15px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    border-radius: var(--border-radius);
    transition: all 0.2s ease-in-out;
    white-space: nowrap;
}
#btnProcess { background-color: var(--primary-color); color: white; }
#btnProcess:hover { background-color: #0056b3; transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15); }
#btnPDF, #btnSharePDF, .short-out-section .control-group button, #btnPreviewSheet {
    background-color: var(--secondary-color);
    color: white;
}
#btnPDF:hover, #btnSharePDF:hover, .short-out-section .control-group button:hover, #btnPreviewSheet:hover {
    background-color: #1e7e34;
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
}
hr { border: 0; height: 1px; background: #ced4da; margin: 20px 0; }
#short-out {
    white-space: pre-line;
    background: var(--background-white);
    padding: 15px;
    border-radius: var(--border-radius);
    font-size: 18px;
    line-height: 1.4;
    border: 1px solid #dee2e6;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
    overflow-wrap: break-word;
    word-break: break-word;
    margin: 10px 0;
    max-width: 100%;
}
/* PDF Styles (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
#preview-container{
    display:flex;
    flex-direction:column;
    gap:15px;
    margin-top:15px;
}
.page-wrap{
    width:842px;
    height:595px;
    margin:0 auto;
    background:white;
    display:grid;
    grid-template-columns:1fr 1fr;
    grid-template-rows:1fr 1fr;
    box-shadow:0 0 5px rgba(0,0,0,.1);
    position:relative;
}
.slot{ 
    box-sizing:border-box; 
    padding:15px; 
    display:flex; 
    flex-direction:column; 
    justify-content:space-between; 
    font-weight:600; 
    position:relative; 
}
.line-top{
    display:flex;
    justify-content:space-between;
    font-size:18px;
    font-weight:700;
}
.line-top>div:first-child{
    font-size:24px;
    font-weight:900;
}
.passenger{
    text-align:center;
    margin-top:15px; 
    margin-bottom:8px; 
    display:block;
    overflow-wrap: break-word;
    word-break: break-word;
    line-height:1.2;
}
.route{
    text-align:center;
    font-size:16px;
    display:block;
    overflow-wrap: break-word;
    word-break: break-word;
    line-height:1.2;
    margin:2px 0; 
}
.code{
    position:absolute;
    right:15px;
    bottom:10px;
    font-size:8px;
}
</style>
</head>

<body>

<h1>üìÑ ‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô/‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡πÅ‡∏ï‡∏ô‡∏ö‡∏≤‡∏¢ üìã</h1>

<div class="input-section">
    <h2>üì• ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h2>
    <div class="input-control-wrapper">
        <textarea id="input" placeholder="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
        <div class="control-group">
            <button id="btnProcess">‚öôÔ∏è ‡πÅ‡∏õ‡∏•‡∏á & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
        </div>
    </div>
</div>

<hr>

<div class="short-out-section">
    <h2>‚úÖ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)</h2>
    <div class="control-group">
        <button onclick="copyShort()">‚úÇÔ∏è ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠</button>
    </div>
    <div id="short-out">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
</div>

<hr>

<h2>üñ®Ô∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå/‡πÅ‡∏ä‡∏£‡πå </h2>
<div class="control-group">
  <button id="btnPreviewSheet">üëÄ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (PDF)</button>
  <button id="btnPDF">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
  <button id="btnSharePDF">üîó ‡πÅ‡∏ä‡∏£‡πå PDF</button>
</div>

<div id="preview-container"></div>

<script>
// =========================================================================================================
// !!! Web App URL ‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì !!!
// =========================================================================================================
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz889F8LVJ7RxEIWJTFCHhxi89qriCSQT86m9UgFY5lN_H5UV0LSYrnKvnbhKC_RPmxdA/exec'; 
// =========================================================================================================

let PutterName = ""; 

/* ---------------------------------------------------------------------------------------------------------
   --- üåé ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á MAP ‡πÅ‡∏•‡∏∞ AREA (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) --- 
   --------------------------------------------------------------------------------------------------------- */
const LOC_MAP = {
  "S": /‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥|bkk|suvarnabhumi/, "D": /‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á|dmk|don mueang/,
  "CM": /‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà|chiang mai|cnx/, "PK": /‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï|phuket|hkt/, "PY": /‡∏û‡∏±‡∏ó‡∏¢‡∏≤|‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ|pattaya|chonburi|utp|‡∏ö‡∏≤‡∏á‡∏•‡∏∞‡∏°‡∏∏‡∏á/, 
  "HH": /‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô|cha-am|chaam|huahin/, "KR": /‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà|krabi|kbv/, "SM": /‡∏™‡∏°‡∏∏‡∏¢|surat thani|samui|usm|surat/, 
  "CR": /‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢|chiang rai/, "AY": /‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤|ayutthaya|ayutaya/, "RY": /‡∏£‡∏∞‡∏¢‡∏≠‡∏á|rayong/,
  "NB": /‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ|nonthaburi/, "PT": /‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ|pathum thani|pathumtani/, "SP": /‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£|samut prakan/, 
  "SS": /‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£|samut sakhon/, "NP": /‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°|nakhon pathom/,
  // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô 'Bk' ‡πÄ‡∏õ‡πá‡∏ô 'BK' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ***
  "BK": /‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û|bangkok/ 
};
function MAP(t){
  t=t.toLowerCase();
  for(const [code, pattern] of Object.entries(LOC_MAP))
    if(pattern.test(t)) return code.length === 1 ? code : code; 
  return "BK"; 
}
const BANGKOK_AREAS = {
  "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£": ["phra nakhon", "‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏•‡∏ß‡∏á", "‡∏ñ‡∏ô‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏£", "‡∏ö‡∏≤‡∏á‡∏•‡∏≥‡∏û‡∏π"], 
  "‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å": ["bang rak", "‡∏™‡∏µ‡∏•‡∏°", "‡∏™‡∏≤‡∏ó‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", "bangrak"],
  "‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô": ["pathum wan", "‡∏™‡∏¢‡∏≤‡∏°", "‡∏ä‡∏¥‡∏î‡∏•‡∏°", "‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏à‡∏¥‡∏ï", "‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ", "‡∏£‡∏≤‡∏ä‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå"],
  "‡∏ß‡∏±‡∏í‡∏ô‡∏≤": ["watthana", "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó", "‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠", "‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢", "‡∏≠‡πÇ‡∏®‡∏Å"],
  "‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á": ["huai khwang", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9", "‡∏£‡∏±‡∏ä‡∏î‡∏≤", "‡πÄ‡∏´‡∏°‡πà‡∏á‡∏à‡πã‡∏≤‡∏¢"],
  "‡∏û‡∏ç‡∏≤‡πÑ‡∏ó": ["phaya thai", "‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå", "‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤"],
  "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": ["ratchathewi", "‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ô‡πâ‡∏≥"],
  "‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£": ["chatuchak", "‡∏ï‡∏•‡∏≤‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£"],
  "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤": ["bang na", "‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç", "‡∏•‡∏≤‡∏ã‡∏≤‡∏•", "‡πÅ‡∏ö‡∏£‡∏¥‡πà‡∏á"],
  "‡πÅ‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏ô": ["dmk|don mueang|‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á"],
  "‡πÅ‡∏≠‡∏£‡πå‡∏™‡∏∏": ["bkk|suvarnabhumi|‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥"],
  "‡∏î‡∏∏‡∏™‡∏¥‡∏ï": ["dusit"], "‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô": ["bang khen"], "‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥": ["bang kapi"], "‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á": ["phra khanong"], 
  "‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": ["min buri"], "‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤": ["yan nawa"], "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå": ["samphanthawong"], "‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": ["thon buri"],
  "‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô": ["taling chan"], "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢": ["bangkok noi"], "‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô": ["bang khun thian"], 
  "‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç": ["phasi charoen"], "‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°": ["nong khaem"], "‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞": ["rat burana"], "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î": ["bang phlat"],
  "‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô": ["bang bon"],
  "‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á": ["din daeng"], // ‡πÄ‡∏û‡∏¥‡πà‡∏° Din Daeng ‡πÉ‡∏ô list ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
  "‡∏Å‡∏ó‡∏°.": ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û|bangkok"]
};
const YARN_OVERRIDE = {
    "‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠": /‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠|thonglor/, "‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢": /‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢|ekkamai/, "‡∏≠‡πÇ‡∏®‡∏Å": /‡∏≠‡πÇ‡∏®‡∏Å|asoke|‡∏ß‡∏±‡∏í‡∏ô‡∏≤|watthana/, 
    "‡∏ô‡∏≤‡∏ô‡∏≤/‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏à‡∏¥‡∏ï": /‡∏ô‡∏≤‡∏ô‡∏≤|nana|‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏à‡∏¥‡∏ï|ploenchit/, "‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ": /‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ|lumphini/,
    "‡∏™‡∏µ‡∏•‡∏°": /‡∏™‡∏µ‡∏•‡∏°|silom/, "‡∏™‡∏¢‡∏≤‡∏°": /‡∏™‡∏¢‡∏≤‡∏°|siam/, "‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä": /‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä|yaowarat/, 
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ô‡πâ‡∏≥": /‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ô‡πâ‡∏≥|pratunam/, "‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢": /‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢|victory/, "‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå": /‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå|aree/, 
    "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏¥‡∏£‡∏¥‡∏Å‡∏¥‡∏ï‡∏¥‡πå": /‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏¥‡∏£‡∏¥‡∏Å‡∏¥‡∏ï‡∏¥‡πå|qsncc/, "‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ô‡∏Ñ‡∏£": /‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ô‡∏Ñ‡∏£|charoen nakhon/,
    "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9": /‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9|rama 9/, "‡∏õ‡∏¥‡πà‡∏ô‡πÄ‡∏Å‡∏•‡πâ‡∏≤": /‡∏õ‡∏¥‡πà‡∏ô‡πÄ‡∏Å‡∏•‡πâ‡∏≤|pin klao/, "‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤": /‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤|ramintra/, 
    "‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç": /‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç|udomsuk/, "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤": /‡∏ö‡∏≤‡∏á‡∏ô‡∏≤|bang na/, "‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á": /‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á|lat krabang/
};
function detectArea(text) {
  if (!text || text.trim() === "") return "‡∏Å‡∏ó‡∏°."; 
  const t = text.toLowerCase();
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Ratchada ‡πÅ‡∏•‡∏∞ Din Daeng
  if (/din\s*daeng|‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á/.test(t)) return "‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á";
  if (/(‡∏£‡∏±‡∏ä‡∏î‡∏≤|ratchada)/.test(t)) return "‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á";
  
  for (const [area, keys] of Object.entries(BANGKOK_AREAS)) {
    if (area === "‡∏Å‡∏ó‡∏°.") continue;
    if (keys.some(k => t.includes(k.replace(/[|]/g, '')))) return area;
  }
  return "‡∏Å‡∏ó‡∏°.";
}

// *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ã‡∏≠‡∏¢‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Override ***
function getAreaForShort(text) {
  if (!text || text.trim() === "") return "‡∏Å‡∏ó‡∏°."; 
  const t = text.toLowerCase();
  
  // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ã‡∏≠‡∏¢‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ '‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó23' ‡πÅ‡∏ó‡∏ô '‡∏ß‡∏±‡∏í‡∏ô‡∏≤')
  const sukhumvitMatch = t.match(/‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó\s*‡∏ã?\s*‡∏≠?\s*‡∏¢?\s*(\d+)/) || t.match(/sukhumvit\s*(soi)?\s*(\d+)/);
  if (sukhumvitMatch) {
    // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á group 1 ‡πÅ‡∏•‡∏∞ group 2
    const soiNumber = (sukhumvitMatch[2] || sukhumvitMatch[1] || '').trim();
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÜ
    if (soiNumber && !isNaN(parseInt(soiNumber))) { 
        return "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó" + parseInt(soiNumber); 
    }
  }
  
  // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô
  if (/dmk|don mueang|‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á/.test(t)) return "‡πÅ‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏ô";
  if (/bkk|suvarnabhumi|‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥/.test(t)) return "‡πÅ‡∏≠‡∏£‡πå‡∏™‡∏∏";
  
  // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö YARN_OVERRIDE (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¢‡∏≤‡∏°, ‡∏™‡∏µ‡∏•‡∏°)
  for(const [yarn, pattern] of Object.entries(YARN_OVERRIDE))
      if(pattern.test(t)) return yarn;
      
  // 4. Fallback ‡πÑ‡∏õ‡∏ó‡∏µ‡πà detectArea ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÄ‡∏Ç‡∏ï/‡∏¢‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á Din Daeng)
  return detectArea(text);
}
function getCode(block){
  const raw=block.match(/„ÄêÊé•È©≥ÁºñÁ†Åcode„Äë(.*)/)||block.match(/code[:Ôºö]?\s*(.*)/i);
  if(!raw) return "";
  return raw[1].trim().match(/[0-9A-Za-z]+/)?.[0]||"";
}

// --------------------------------------------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Array of Objects
function getAllJobData() {
    const raw = document.getElementById("input").value;
    if (!raw.trim()) return [];
    
    const blocks = raw.split(/(?=D\d{4,}-\d{2})/).filter(x => x.trim());
    const jobData = [];

    blocks.forEach(b => {
        const id = (b.match(/D\d{4,}-\d{2}/) || [""])[0];
        const time = (b.match(/„ÄêÊó∂Èó¥‡πÄ‡∏ß‡∏•‡∏≤„Äë(.*)/) || ["", ""])[1].trim();
        const flt = (b.match(/„ÄêËà™Áè≠flight„Äë(.*)/) || ["", ""])[1].trim();
        const pk = (b.match(/„ÄêÊé•‡∏£‡∏±‡∏ö„Äë(.*)/) || ["", ""])[1].trim();
        const dp = (b.match(/„ÄêÈÄÅ‡∏™‡πà‡∏á„Äë(.*)/) || ["", ""])[1].trim();
        const car = (b.match(/„ÄêËΩ¶Âûã‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ñ„Äë(.*)/) || ["", ""])[1].trim();
        const seat = car.includes("5") ? 5 : 7;
        const A = MAP(pk), B = MAP(dp);
        const areaA = getAreaForShort(pk);
        const areaB = getAreaForShort(dp);
        const date = (b.match(/„ÄêÊó•Êúü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà„Äë(.*)/) || ["", ""])[1].trim();

        jobData.push({
            date: date,
            id: id,
            time: time,
            seat: seat,
            mapFrom: A,
            mapTo: B,
            areaFrom: areaA,
            areaTo: areaB,
            flight: flt,
            putter: PutterName 
        });
    });
    return jobData;
}
// --------------------------------------------------------------------------

// *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ Google Sheets (‡πÑ‡∏°‡πà‡∏°‡∏µ Pop-up ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à) ***
async function sendToGoogleSheet(jobData) {
    if (jobData.length === 0) {
        alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ");
        return false;
    }
    
    const sendPromises = jobData.map(data => {
        const formData = new FormData();
        formData.append('data', JSON.stringify(data));

        return fetch(WEB_APP_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors' 
        }).then(response => {
            return { status: 'Sent', id: data.id };
        }).catch(error => {
            console.error('Fetch Error:', error);
            return { status: 'Error', id: data.id, error: error.message };
        });
    });

    const results = await Promise.all(sendPromises);
    
    const errorCount = results.filter(r => r.status === 'Error').length;

    if (errorCount === 0) {
        // ‚úÖ SUCCESS: ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô console log ‡πÅ‡∏ó‡∏ô)
        console.log(`Job data for ${jobData.length} jobs sent successfully.`); 
    } else {
        // ‚ö†Ô∏è ERROR: ‡∏Ñ‡∏á alert ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏ß‡πâ
        alert(`‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errorCount} ‡∏á‡∏≤‡∏ô (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Apps Script Logs)`);
    }
    return true;
}
// --------------------------------------------------------------------------

// *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö Short Out 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) ***
function parseShort(){
  const raw=document.getElementById("input").value;
  if(!raw.trim()) return "";
  const blocks=raw.split(/(?=D\d{4,}-\d{2})/).filter(x=>x.trim());
  let out="";
  let firstDate = "";
  if (blocks.length > 0) {
      const dateMatch = blocks[0].match(/„ÄêÊó•Êúü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà„Äë(.*)/);
      firstDate = dateMatch ? dateMatch[1].trim() : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
  }
  out += firstDate + "\n";
  out += "------------------------------\n";
  
  const jobData = getAllJobData(); 
  
  jobData.forEach(job=>{
    // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 1: ID//Time//#Seat MapFrom-MapTo
    out+=`${job.id}//${job.time}//#${job.seat}${job.mapFrom}-${job.mapTo}\n`;
    
    // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 2: AreaFrom‚ÄìAreaTo ‚úàÔ∏èFlight
    out+=`${job.areaFrom}‚Äì${job.areaTo}`;
    if(job.flight) out+=` ‚úàÔ∏è${job.flight}`;
    out+=`\n`;
  });
  return out.trim();
}
// --------------------------------------------------------------------------

// *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠, ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•, ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•, ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ***
async function processAndSend() {
    const inputContent = document.getElementById("input").value.trim();
    if (!inputContent) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }

    let name = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô(‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ):", PutterName || "");
    
    if (name === null || name.trim() === "") {
        alert("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
        return;
    }

    PutterName = name.trim();
    
    // 1. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    document.getElementById("short-out").textContent = parseShort(); 
    fillPreview();
    
    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á
    const jobData = getAllJobData();
    
    // 3. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets
    await sendToGoogleSheet(jobData);
}
// -------------------------------------------------------------------------


/* ------------------- PDF SYSTEM & Utility Functions (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ------------------- */
function copyShort() {
  const shortEl = document.getElementById("short-out");
  const text = shortEl.innerText || shortEl.textContent;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => { alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úî"); })
    .catch(() => fallbackCopy(text));
  } else { fallbackCopy(text); }
}
function fallbackCopy(text) {
  const textarea = document.createElement("textarea"); textarea.value = text; document.body.appendChild(textarea);
  textarea.select();
  try { document.execCommand("copy"); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úî"); }
  catch(e){ alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå"); }
  document.body.removeChild(textarea);
}
function splitJobs(t){ let b=[],c=[]; for(const l of t.split(/\n/).map(s=>s.trim())){ if(/^[A-Z]\d{3,5}-\d{1,2}/.test(l)){ if(c.length) b.push(c.join("\n")); c=[l]; } else if(l) c.push(l); } if(c.length) b.push(c.join("\n")); return b; }
function getVal(t,k){ const m=t.match(new RegExp("„Äê"+k+"„Äë([^\\n]*)")); return m?m[1].trim():""; }
function shortName(n){ if(!n) return ""; n=n.split("(")[0]; const w=n.replace(/[^\w‡∏Å-‡πô\s]/g," ").trim().split(/\s+/); return w.slice(0,3).join(" "); }
function parseJob(b){ const j=b.match(/^[A-Z]\d{3,5}-\d{1,2}/)?.[0]||""; return{jobcode:j,date:getVal(b,"Êó•Êúü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"),time:getVal(b,"Êó∂Èó¥‡πÄ‡∏ß‡∏•‡∏≤"),name:getVal(b,"ÂßìÂêç‡∏ä‡∏∑‡πà‡∏≠")||"",route:shortName(getVal(b,"Êé•‡∏£‡∏±‡∏ö"))+" ‚Üí "+shortName(getVal(b,"ÈÄÅ‡∏™‡πà‡∏á")),code:getCode(b)}; }
function getJobs(){ const r=document.getElementById("input").value.trim(); return r?splitJobs(r).map(parseJob):[]; }
function adjustFontSize(el,maxFont,minFont){ if(!el) return; let f=maxFont; el.style.fontSize=f+"px"; while((el.scrollWidth>el.clientWidth||el.scrollHeight>el.clientHeight)&&f>minFont){ f--; el.style.fontSize=f+"px"; } }
function makePage(jobs4){
  const w=document.createElement("div"); w.className="page-wrap";
  for(let i=0;i<4;i++){
    const j=jobs4[i]; const s=document.createElement("div"); s.className="slot";
    s.innerHTML=`<div class="line-top"><div>${j?j.jobcode:""}</div><div>${j?j.time:""}</div><div>${j?j.date:""}</div></div><div class="passenger">${j?j.name:""}</div><div class="route">${j?j.route:""}</div><div class="code">${j?j.code:""}</div>`;
    
    adjustFontSize(s.querySelector(".passenger"), 28, 10); 
    adjustFontSize(s.querySelector(".route"), 18, 8);
    
    w.appendChild(s);
  }
  return w;
}
function fillPreview(){ 
    const w=document.getElementById("preview-container"); 
    w.innerHTML=""; 
    const j=getJobs(); 
    if(!j.length) return; 
    for(let i=0;i<j.length;i+=4) w.appendChild(makePage(j.slice(i,i+4))); 
}
async function buildPDF(){ const {jsPDF}=window.jspdf; const pages=document.querySelectorAll(".page-wrap"); const pdf=new jsPDF({orientation:"landscape",unit:"pt",format:[842,595]}); for(let i=0;i<pages.length;i++){ const c=await html2canvas(pages[i],{scale:1.5}); pdf.addImage(c.toDataURL('image/jpeg', 0.7), 'JPEG', 0, 0, 842, 595); if(i<pages.length-1) pdf.addPage(); } return pdf; }
function getFileName(){ const r=document.getElementById("input").value.trim(); const m=r.match(/^([A-Z]\d{3,5})-/); return m?m[1]:"JobSheet"; }

document.getElementById("btnProcess").onclick = processAndSend; 
document.getElementById("btnPreviewSheet").onclick=fillPreview;
document.getElementById("btnPDF").onclick=async()=>{ const pdf=await buildPDF(); pdf.save(getFileName()+".pdf"); };
document.getElementById("btnSharePDF").onclick=async()=>{ const pdf=await buildPDF(); const blob=pdf.output("blob"); const file=new File([blob],getFileName()+".pdf",{type:"application/pdf"}); if(navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file],title:"Job Sheet"}); } else { pdf.save(getFileName()+".pdf"); } };
</script>

</body>
</html>
