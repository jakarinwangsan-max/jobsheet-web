<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>Job Parser + Job Sheet v12.8 ‚Äî Final Fix Metro Code</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Helvetica,Arial,sans-serif;background:#f6f6f6;padding:20px}
textarea{width:100%;height:200px;font-family:monospace;padding:8px;border:1px solid #ccc}
button{padding:8px 14px;font-size:15px;margin:4px;cursor:pointer}
#short-out{white-space:pre-line;background:white;padding:14px;border-radius:8px;margin-top:10px;font-size:20px;line-height:1.3;border:1px solid #ddd;overflow-wrap: break-word;word-break: break-word;}
#preview-container{display:flex;flex-direction:column;gap:20px;margin-top:20px}

.page-wrap{width:842px;height:595px;margin:0 auto;background:white;
 display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;
 box-shadow:0 0 6px rgba(0,0,0,.15);position:relative}

.slot{box-sizing:border-box;padding:24px;display:flex;flex-direction:column;
 justify-content:space-between;font-weight:700;position:relative}

.line-top{display:flex;justify-content:space-between;font-size:24px;font-weight:700}
.line-top>div:first-child{font-size:34px;font-weight:900}

.passenger{text-align:center;margin-top:30px;margin-bottom:15px;
 display:block;overflow-wrap: break-word;word-break: break-word;line-height:1.2}

.route{text-align:center;font-size:22px;display:block;
 overflow-wrap: break-word;word-break: break-word;line-height:1.2;margin:5px 0}

.code{position:absolute;right:20px;bottom:14px;font-size:10px}
</style>
</head>

<body>

<h1>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡πÅ‡∏ï‡∏ô‡∏ö‡∏≤‡∏¢ (üöñ‡∏£‡∏ñ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô y&t) 2.1.1</h1>

<textarea id="input" placeholder="‡∏ß‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea><br>

<button id="btnProcess">‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</button>

<hr>

<h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ </h2>
<button onclick="copyShort()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠</button>
<div id="short-out"></div>

<hr>

<h2>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô 4 ‡∏ä‡πà‡∏≠‡∏á </h2>
<div class="controls">
  <button id="btnPreviewSheet">‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
  <button id="btnPDF">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
  <button id="btnSharePDF">‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•‡∏î</button>
</div>

<div id="preview-container"></div>

<script>
/* ------------------- MAP (FINAL VERSION) ------------------- */
function MAP(t){
  t=t.toLowerCase();
  
  // 1. ‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å (1 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
  if(/‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥|bkk|suvarnabhumi/.test(t)) return "S"; // S: Suvarnabhumi
  if(/‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á|dmk|don mueang/.test(t)) return "D"; // D: Don Mueang

  // 2. ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß / ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
  if(/‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà|chiang mai|cnx/.test(t)) return "CM"; // CM: Chiang Mai
  if(/‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï|phuket|hkt/.test(t)) return "PK"; // PK: Phuket
  if(/‡∏û‡∏±‡∏ó‡∏¢‡∏≤|‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ|pattaya|chonburi|utp|‡∏ö‡∏≤‡∏á‡∏•‡∏∞‡∏°‡∏∏‡∏á/.test(t)) return "PY"; // PY: Pattaya/Chonburi
  if(/‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô|cha-am|chaam|huahin/.test(t)) return "HH"; // HH: Hua Hin
  if(/‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà|krabi|kbv/.test(t)) return "KR"; // KR: Krabi
  if(/‡∏™‡∏°‡∏∏‡∏¢|surat thani|samui|usm|surat/.test(t)) return "SM"; // SM: Samui/Surat Thani
  if(/‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢|chiang rai|ce/.test(t)) return "CR"; // CR: Chiang Rai
  if(/‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤|ayutthaya|ayutaya/.test(t)) return "AY"; // AY: Ayutthaya
  if(/‡∏£‡∏∞‡∏¢‡∏≠‡∏á|rayong/.test(t)) return "RY"; // RY: Rayong
  
  // 3. ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏• (Metropolitan Region)
  if(/‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ|nonthaburi/.test(t)) return "NB"; // NB: Nonthaburi
  if(/‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ|pathum thani|pathumtani/.test(t)) return "PT"; // PT: Pathum Thani
  if(/‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£|samut prakan/.test(t)) return "SP"; // SP: Samut Prakan
  if(/‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£|samut sakhon/.test(t)) return "SS"; // SS: Samut Sakhon
  if(/‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°|nakhon pathom/.test(t)) return "NP"; // NP: Nakhon Pathom
  
  // 4. ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
  return "BK"; // BK: BangKok (Default)
}

/* ------------------- detectArea (50 ‡πÄ‡∏Ç‡∏ï + ‡∏¢‡πà‡∏≤‡∏ô) ------------------- */
function detectArea(text) {
  if (!text || text.trim() === "") return "‡∏Å‡∏ó‡∏°."; 
  
  const t = text.toLowerCase();
  
  // FIX: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ ‡∏Å‡πà‡∏≠‡∏ô BANGKOK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£'
  if(/‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤|ayutthaya|ayutaya/.test(t)) return "‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤"; 
  
  if (/dmk|don mueang|‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á/.test(t)) return "‡πÅ‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏ô";
  if (/bkk|suvarnabhumi|‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥/.test(t)) return "‡πÅ‡∏≠‡∏£‡πå‡∏™‡∏∏";

  const BANGKOK = {
    // 50 ‡πÄ‡∏Ç‡∏ï‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏¢‡πà‡∏≤‡∏ô
    "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£": ["phra nakhon", "‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏•‡∏ß‡∏á", "sanam luang", "‡∏ñ‡∏ô‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏£", "khao san", "‡∏ö‡∏≤‡∏á‡∏•‡∏≥‡∏û‡∏π", "bang lamphu"], 
    "‡∏î‡∏∏‡∏™‡∏¥‡∏ï": ["dusit", "‡∏£‡∏±‡∏ê‡∏™‡∏†‡∏≤", "parliament", "‡∏ß‡∏±‡∏á‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "sukhothai palace", "‡∏™‡∏≤‡∏°‡πÄ‡∏™‡∏ô", "samsen"], 
    "‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å": ["nong chok"], 
    "‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å": ["bang rak", "‡∏™‡∏µ‡∏•‡∏°", "silom", "‡∏™‡∏≤‡∏ó‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", "north sathorn", "‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å", "bangrak"],
    "‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô": ["bang khen", "‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤", "ramintra", "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", "saphan mai"], 
    "‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥": ["bang kapi", "‡∏ô‡∏ß‡∏°‡∏¥‡∏ô‡∏ó‡∏£‡πå", "nawamin", "‡∏•‡∏≥‡∏™‡∏≤‡∏•‡∏µ", "lum salee", "‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥", "bang kapi"],
    "‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô": ["pathum wan", "‡∏™‡∏¢‡∏≤‡∏°", "siam", "‡∏ä‡∏¥‡∏î‡∏•‡∏°", "chidlom", "‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏à‡∏¥‡∏ï", "ploenchit", "‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ", "lumphini", "‡∏£‡∏≤‡∏ä‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå", "ratchaprasong"],
    "‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö": ["pom prap", "‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä", "yaowarat", "‡∏™‡∏≥‡πÄ‡∏û‡πá‡∏á", "sampheng", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏ñ‡∏°", "khlong thom"],
    "‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á": ["phra khanong", "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó 71", "sukhumvit 71"], 
    "‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": ["min buri", "‡∏ï‡∏•‡∏≤‡∏î‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "min buri market"],
    "‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á": ["lat krabang", "‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á", "lat krabang", "‡πÅ‡∏≠‡∏£‡πå‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå", "airport link"],
    "‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤": ["yan nawa", "‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤", "yan nawa"], 
    "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå": ["samphanthawong", "‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä", "yaowarat", "‡∏™‡∏≥‡πÄ‡∏û‡πá‡∏á", "sampheng"],
    "‡∏û‡∏ç‡∏≤‡πÑ‡∏ó": ["phaya thai", "‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå", "aree", "‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤", "sanam pao"],
    "‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": ["thon buri", "‡∏ß‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏ç‡πà", "wongwian yai", "‡∏ï‡∏•‡∏≤‡∏î‡∏û‡∏•‡∏π", "talat phlu"],
    "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà": ["bangkok yai", "‡∏≠‡∏¥‡∏™‡∏£‡∏†‡∏≤‡∏û", "itsaraphap"], 
    "‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á": ["huai khwang", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9", "rama 9", "‡∏£‡∏±‡∏ä‡∏î‡∏≤", "ratchada", "‡πÄ‡∏´‡∏°‡πà‡∏á‡∏à‡πã‡∏≤‡∏¢", "meng jai"],
    "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô": ["khlong san", "‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ô‡∏Ñ‡∏£", "charoen nakhon", "‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏¢‡∏≤‡∏°", "iconsiam"],
    "‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô": ["taling chan", "‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ", "borommaratchachonnani"],
    "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢": ["bangkok noi", "‡∏®‡∏¥‡∏£‡∏¥‡∏£‡∏≤‡∏ä", "siriraj", "‡∏à‡∏£‡∏±‡∏ç‡∏™‡∏ô‡∏¥‡∏ó‡∏ß‡∏á‡∏®‡πå", "charan sanit wong"], 
    "‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô": ["bang khun thian", "‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô 4", "bang bon 4", "‡∏ä‡∏≤‡∏¢‡∏ó‡∏∞‡πÄ‡∏•‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô", "bang khun thian sea"], 
    "‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç": ["phasi charoen", "‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°", "phetkasem"],
    "‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°": ["nong khaem", "‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ì‡∏ë‡∏•‡∏™‡∏≤‡∏¢ 3", "phutthamonthon sai 3"],
    "‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞": ["rat burana", "‡∏™‡∏∏‡∏Ç‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå", "suksawat"], 
    "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î": ["bang phlat", "‡∏™‡∏¥‡∏£‡∏¥‡∏ô‡∏ò‡∏£", "sirindhorn", "‡∏õ‡∏¥‡πà‡∏ô‡πÄ‡∏Å‡∏•‡πâ‡∏≤", "pin klao"],
    "‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á": ["din daeng", "‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢", "victory", "‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á", "din daeng triangle"],
    "‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°": ["bueng kum", "‡∏ô‡∏ß‡∏°‡∏¥‡∏ô‡∏ó‡∏£‡πå", "nawamin", "‡πÄ‡∏™‡∏£‡∏µ‡πÑ‡∏ó‡∏¢", "seri thai"],
    "‡∏™‡∏≤‡∏ó‡∏£": ["sathorn", "‡∏™‡∏≤‡∏ó‡∏£‡πÉ‡∏ï‡πâ", "south sathorn", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "narathiwas"],
    "‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠": ["bang sue", "‡πÄ‡∏ï‡∏≤‡∏õ‡∏π‡∏ô", "tao poon"], 
    "‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£": ["chatuchak", "‡∏ï‡∏•‡∏≤‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£", "chatuchak market", "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß‡∏ã‡∏≠‡∏¢ 1", "lat phrao soi 1"],
    "‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°": ["bang kho laem", "‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°", "bang kho laem"], 
    "‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®": ["prawet", "‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "srinakarin", "‡∏≠‡πà‡∏≠‡∏ô‡∏ô‡∏∏‡∏ä", "on nut"],
    "‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢": ["khlong toei", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 4", "rama 4", "‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢", "khlong toey"], 
    "‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á": ["suan luang", "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£", "pattanakarn", "‡∏≠‡πà‡∏≠‡∏ô‡∏ô‡∏∏‡∏ä", "on nut"],
    "‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á": ["chom thong", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 2", "rama 2"], 
    "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": ["ratchathewi", "‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢", "victory", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ô‡πâ‡∏≥", "pratunam"],
    "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß": ["lat phrao", "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß 71", "lat phrao 71", "‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏±‡∏¢ 4", "chokchai 4"],
    "‡∏ß‡∏±‡∏í‡∏ô‡∏≤": ["watthana", "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó", "sukhumvit", "‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠", "thonglor", "‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢", "ekkamai", "‡∏≠‡πÇ‡∏®‡∏Å", "asoke"],
    "‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ": ["bang khae", "‡πÄ‡∏î‡∏≠‡∏∞‡∏°‡∏≠‡∏•‡∏•‡πå‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ", "the mall bangkae"],
    "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà": ["lak si", "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£", "government complex", "‡πÑ‡∏≠‡∏ó‡∏µ‡∏™‡πÅ‡∏Ñ‡∏ß‡∏£‡πå", "it square"],
    "‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°": ["sai mai", "‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô 54/1", "phaholyothin 54/1"],
    "‡∏Ñ‡∏±‡∏ô‡∏ô‡∏≤‡∏¢‡∏≤‡∏ß": ["khan na yao", "‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏≠‡∏™‡πå‡πÅ‡∏•‡∏ô‡∏î‡πå", "fashion island"],
    "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á": ["saphan sung", "‡∏ã‡∏≠‡∏¢‡∏°‡∏¥‡∏™‡∏ó‡∏µ‡∏ô", "soi mistine"],
    "‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á": ["wang thonglang", "‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡∏≠‡∏¥‡∏ô‡∏ó‡∏≤‡∏ß‡∏ô‡πå", "town in town", "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß 112", "lat phrao 112"],
    "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤": ["khlong sam wa", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤", "khlong sam wa"], 
    "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤": ["bang na", "‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç", "udomsuk", "‡∏•‡∏≤‡∏ã‡∏≤‡∏•", "lasalle", "‡πÅ‡∏ö‡∏£‡∏¥‡πà‡∏á", "bearing"],
    "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏": ["thung khru", "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏≠‡∏∏‡∏ó‡∏¥‡∏®", "pracha uthit"], 
    "‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô": ["bang bon", "‡πÄ‡∏≠‡∏Å‡∏ä‡∏±‡∏¢", "ekkachai"], 
    "‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤": ["thawi watthana", "‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤", "thawi watthana"], 
    "‡∏ö‡∏≤‡∏á‡∏à‡∏≤‡∏Å": ["bang chak", "‡∏ö‡∏≤‡∏á‡∏à‡∏≤‡∏Å", "bang chak"]
  };

  const METRO = {
    // ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ, ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ, ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£, ‡∏Ø‡∏•‡∏Ø
    // ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏¢‡πà‡∏≠ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô MAP function ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô detectArea ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°
    "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ": ["muang nonthaburi","‡∏ï‡∏¥‡∏ß‡∏≤‡∏ô‡∏ô‡∏ó‡πå"], "‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á": ["bang bua thong"], "‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î": ["pak kret"],
    "‡∏ö‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà": ["bang yai"], "‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢": ["sai noi"],
    "‡∏ò‡∏±‡∏ç‡∏ö‡∏∏‡∏£‡∏µ": ["thanyaburi","rangsit"], "‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á": ["khlong luang"], "‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤": ["lam luk ka"], "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ": ["muang pathum"],
    "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£": ["muang samut prakan","paknam"], "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ": ["bang phli"], "‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á": ["bang sao thong"], "‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á": ["phra pradaeng"],
    "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£": ["muang samut sakhon"], "‡∏Å‡∏£‡∏∞‡∏ó‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ô": ["krathum baen"], "‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏û‡πâ‡∏ß": ["ban phaeo"],
    "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°": ["muang nakhon pathom"], "‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ì‡∏ë‡∏•": ["phutthamonthon"], "‡∏™‡∏≤‡∏°‡∏û‡∏£‡∏≤‡∏ô": ["samphran"],
    "‡∏û‡∏±‡∏ó‡∏¢‡∏≤‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": ["north pattaya"], "‡∏û‡∏±‡∏ó‡∏¢‡∏≤‡∏Å‡∏•‡∏≤‡∏á": ["central pattaya"], "‡∏û‡∏±‡∏ó‡∏¢‡∏≤‡πÉ‡∏ï‡πâ": ["south pattaya"],
    "‡∏ö‡∏≤‡∏á‡∏•‡∏∞‡∏°‡∏∏‡∏á": ["bang lamung"], "‡∏´‡∏ô‡∏≠‡∏á‡∏õ‡∏£‡∏∑‡∏≠": ["nong prue"], "‡∏™‡∏±‡∏ï‡∏´‡∏µ‡∏ö": ["sattahip"],
    "‡∏£‡∏∞‡∏¢‡∏≠‡∏á": ["rayong"], "‡∏ö‡πâ‡∏≤‡∏ô‡∏â‡∏≤‡∏á": ["ban chang"],
    "‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏≠‡∏¥‡∏ô": ["bang pa-in"],
    "‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô": ["hua hin"], "‡∏ä‡∏∞‡∏≠‡∏≥": ["cha-am"],
    "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï": ["phuket"], "‡∏õ‡πà‡∏≤‡∏ï‡∏≠‡∏á": ["patong"], "‡∏Å‡∏∞‡∏ï‡∏∞": ["kata"], "‡∏Å‡∏∞‡∏£‡∏ô": ["karon"],
    "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": ["chiang mai"], "‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô": ["nimman"],
    "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢": ["chiang rai"], "‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏¢": ["mae sai"]
  };

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
  for (const [area, keys] of Object.entries(BANGKOK))
    if (keys.some(k => t.includes(k))) return area;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏• + ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  for (const [area, keys] of Object.entries(METRO))
    if (keys.some(k => t.includes(k))) return area;

  return "‡∏Å‡∏ó‡∏°.";
}
/* ------------------- getAreaForShort (‡πÅ‡∏™‡∏î‡∏á‡∏¢‡πà‡∏≤‡∏ô‡πÅ‡∏ó‡∏ô‡πÄ‡∏Ç‡∏ï) ------------------- */
function getAreaForShort(text) {
  if (!text || text.trim() === "") return "‡∏Å‡∏ó‡∏°."; 
  
  const t = text.toLowerCase();

  // 1. FIX: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö '‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó' ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ã‡∏≠‡∏¢ (Sukhumvit + Number) ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó 13, sukhumvit soi 13, sukhumvit13
  const sukhumvitMatch = t.match(/‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó\s*‡∏ã?\s*‡∏≠?\s*‡∏¢?\s*(\d+)/) || t.match(/sukhumvit\s*(soi)?\s*(\d+)/);
  if (sukhumvitMatch) {
    const soiNumber = sukhumvitMatch[2] || sukhumvitMatch[1]; // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡∏õ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ
    return "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó" + soiNumber.trim();
  }

  // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡πà‡∏≤‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô
  if (/dmk|don mueang|‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á/.test(t)) return "‡πÅ‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏ô";
  if (/bkk|suvarnabhumi|‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥/.test(t)) return "‡πÅ‡∏≠‡∏£‡πå‡∏™‡∏∏";

  // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡πà‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏¢‡πà‡∏≤‡∏ô‡∏î‡∏±‡∏á override ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï)
  
  // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó (‡∏¢‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ã‡∏≠‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏ô‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô)
  if(/‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠|thonglor/.test(t)) return "‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠";
  if(/‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢|ekkamai/.test(t)) return "‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢";
  if(/‡∏≠‡πÇ‡∏®‡∏Å|asoke/.test(t)) return "‡∏≠‡πÇ‡∏®‡∏Å";
  
  // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏à‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  if(/‡∏™‡∏µ‡∏•‡∏°|silom/.test(t)) return "‡∏™‡∏µ‡∏•‡∏°"; 
  if(/‡∏™‡∏¢‡∏≤‡∏°|siam/.test(t)) return "‡∏™‡∏¢‡∏≤‡∏°";
  if(/‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä|yaowarat/.test(t)) return "‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä";
  if(/‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢|victory/.test(t)) return "‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢";
  if(/‡∏™‡∏≤‡∏°‡πÄ‡∏™‡∏ô|samsen/.test(t)) return "‡∏™‡∏≤‡∏°‡πÄ‡∏™‡∏ô"; 

  // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  if(/‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9|rama 9/.test(t)) return "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9";
  if(/‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå|aree/.test(t)) return "‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå";
  if(/‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ô‡∏Ñ‡∏£|charoen nakhon/.test(t)) return "‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ô‡∏Ñ‡∏£";
  if(/‡∏õ‡∏¥‡πà‡∏ô‡πÄ‡∏Å‡∏•‡πâ‡∏≤|pin klao/.test(t)) return "‡∏õ‡∏¥‡πà‡∏ô‡πÄ‡∏Å‡∏•‡πâ‡∏≤";
  if(/‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤|ramintra/.test(t)) return "‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤";
  if(/‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç|udomsuk/.test(t)) return "‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç";
  if(/‡∏ö‡∏≤‡∏á‡∏ô‡∏≤|bang na/.test(t)) return "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤";
  
  // 4. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ detectArea (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠)
  return detectArea(text);
}



  
/* ------------------- getCode ------------------- */
function getCode(block){
  const raw=block.match(/„ÄêÊé•È©≥ÁºñÁ†Åcode„Äë(.*)/)||block.match(/code[:Ôºö]?\s*(.*)/i);
  if(!raw) return "";
  return raw[1].trim().match(/[0-9A-Za-z]+/)?.[0]||"";
}

/* ------------------- parseShort ------------------- */
function parseShort(){
  const raw=document.getElementById("input").value;
  if(!raw.trim()) return "";

  const blocks=raw.split(/(?=D\d{4,}-\d{2})/).filter(x=>x.trim());
  let out="";

  let firstDate = "";
  if (blocks.length > 0) {
      const dateMatch = blocks[0].match(/„ÄêÊó•Êúü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà„Äë(.*)/);
      firstDate = dateMatch ? dateMatch[1].trim() : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
  }

  out += firstDate + "\n";
  out += "------------------------------\n";

  blocks.forEach(b=>{
    const id=(b.match(/D\d{4,}-\d{2}/)||[""])[0];
    const time=(b.match(/„ÄêÊó∂Èó¥‡πÄ‡∏ß‡∏•‡∏≤„Äë(.*)/)||["",""])[1].trim();
    const flt=(b.match(/„ÄêËà™Áè≠flight„Äë(.*)/)||["",""])[1].trim();
    const pk=(b.match(/„ÄêÊé•‡∏£‡∏±‡∏ö„Äë(.*)/)||["",""])[1].trim();
    const dp=(b.match(/„ÄêÈÄÅ‡∏™‡πà‡∏á„Äë(.*)/)||["",""])[1].trim();
    const car=(b.match(/„ÄêËΩ¶Âûã‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ñ„Äë(.*)/)||["",""])[1].trim();

    const seat=car.includes("5")?5:7;
    const price=seat===5?400:500;

    const A=MAP(pk), B=MAP(dp);

    const areaA=getAreaForShort(pk); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏¢‡πà‡∏≤‡∏ô
    const areaB=getAreaForShort(dp); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏¢‡πà‡∏≤‡∏ô
    
    out+=`${id}(‚ôªÔ∏è)${time}/${price}#${seat}${A}-${B}\n`;
    out+=`${areaA}‚Äì${areaB}`;
    if(flt) out+=` ‚úàÔ∏è${flt}`;
    out+=`\n`;
  });

  return out.trim();
}
/* ------------------- copyShort ------------------- */
function copyShort() {
  const shortEl = document.getElementById("short-out");
  const text = shortEl.innerText || shortEl.textContent;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => { alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úî"); })
    .catch(() => fallbackCopy(text));
  } else { fallbackCopy(text); }
}

function fallbackCopy(text) {
  const textarea = document.createElement("textarea");
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  try { document.execCommand("copy"); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úî"); }
  catch(e){ alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå"); }
  document.body.removeChild(textarea);
}

/* ------------------- PDF System ------------------- */
function splitJobs(t){
  let b=[],c=[];
  for(const l of t.split(/\n/).map(s=>s.trim())){
    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Dxxxx-xx ‡πÅ‡∏•‡∏∞ Axxxx-xx (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if(/^[A-Z]\d{3,5}-\d{1,2}/.test(l)){ 
      if(c.length) b.push(c.join("\n"));
      c=[l];
    } else if(l) c.push(l);
  }
  if(c.length) b.push(c.join("\n"));
  return b;
}

function getVal(t,k){ const m=t.match(new RegExp("„Äê"+k+"„Äë([^\\n]*)")); return m?m[1].trim():""; }
function shortName(n){ if(!n) return ""; n=n.split("(")[0]; const w=n.replace(/[^\w‡∏Å-‡πô\s]/g," ").trim().split(/\s+/); return w.slice(0,3).join(" "); }
function parseJob(b){ const j=b.match(/^[A-Z]\d{3,5}-\d{1,2}/)?.[0]||""; return{jobcode:j,date:getVal(b,"Êó•Êúü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"),time:getVal(b,"Êó∂Èó¥‡πÄ‡∏ß‡∏•‡∏≤"),name:getVal(b,"ÂßìÂêç‡∏ä‡∏∑‡πà‡∏≠")||"",route:shortName(getVal(b,"Êé•‡∏£‡∏±‡∏ö"))+" ‚Üí "+shortName(getVal(b,"ÈÄÅ‡∏™‡πà‡∏á")),code:getCode(b)}; }
function getJobs(){ const r=document.getElementById("input").value.trim(); return r?splitJobs(r).map(parseJob):[]; }

function adjustFontSize(el,maxFont,minFont){ if(!el) return; let f=maxFont; el.style.fontSize=f+"px"; while((el.scrollWidth>el.clientWidth||el.scrollHeight>el.clientHeight)&&f>minFont){ f--; el.style.fontSize=f+"px"; } }

function makePage(jobs4){
  const w=document.createElement("div"); w.className="page-wrap";
  for(let i=0;i<4;i++){
    const j=jobs4[i]; const s=document.createElement("div"); s.className="slot";
    s.innerHTML=`<div class="line-top"><div>${j?j.jobcode:""}</div><div>${j?j.time:""}</div><div>${j?j.date:""}</div></div><div class="passenger">${j?j.name:""}</div><div class="route">${j?j.route:""}</div><div class="code">${j?j.code:""}</div>`;
    adjustFontSize(s.querySelector(".passenger"),34,12);
    adjustFontSize(s.querySelector(".route"),22,10);
    w.appendChild(s);
  }
  return w;
}


function fillPreview(){ 
    const w=document.getElementById("preview-container"); 
    w.innerHTML=""; 
    const j=getJobs(); 
    if(!j.length) return; 
    for(let i=0;i<j.length;i+=4) w.appendChild(makePage(j.slice(i,i+4))); 
}

async function buildPDF(){ const {jsPDF}=window.jspdf; const pages=document.querySelectorAll(".page-wrap"); const pdf=new jsPDF({orientation:"landscape",unit:"pt",format:[842,595]}); for(let i=0;i<pages.length;i++){ const c=await html2canvas(pages[i],{scale:1.5}); pdf.addImage(c.toDataURL('image/jpeg', 0.7), 'JPEG', 0, 0, 842, 595); if(i<pages.length-1) pdf.addPage(); } return pdf; }

function getFileName(){ const r=document.getElementById("input").value.trim(); const m=r.match(/^([A-Z]\d{3,5})-/); return m?m[1]:"JobSheet"; }

document.getElementById("btnProcess").onclick=()=>{
  document.getElementById("short-out").textContent=parseShort();
  fillPreview();
};
document.getElementById("btnPreviewSheet").onclick=fillPreview;
document.getElementById("btnPDF").onclick=async()=>{ const pdf=await buildPDF(); pdf.save(getFileName()+".pdf"); };
document.getElementById("btnSharePDF").onclick=async()=>{ const pdf=await buildPDF(); const blob=pdf.output("blob"); const file=new File([blob],getFileName()+".pdf",{type:"application/pdf"}); if(navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file],title:"Job Sheet"}); } else { pdf.save(getFileName()+".pdf"); } };
</script>

</body>
</html>

