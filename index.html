<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Job Parser) v15.7 (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô‡πÉ‡∏ô PDF)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* Style Sheet */
:root{--primary-color:#007bff;--secondary-color:#28a745;--background-light:#f7f7f7;--background-white:#fff;--text-color:#000;--border-radius:8px}
body{font-family:'Kanit',sans-serif;background:var(--background-light);padding:20px;color:var(--text-color);max-width:1200px;margin:0 auto}
h1{color:var(--primary-color);font-weight:700;margin-bottom:15px;padding-bottom:8px;border-bottom:3px solid var(--primary-color);display:inline-block}
h2{color:#495057;font-weight:600;margin-top:20px;margin-bottom:10px}
.input-section{display:flex;flex-direction:column}
.input-control-wrapper{display:flex;gap:15px;align-items:flex-end}
.input-control-wrapper textarea{flex-grow:1;width:100%}
.control-group{display:flex;flex-direction:column;gap:8px;margin-bottom:15px;flex-shrink:0}
textarea{height:200px;font-family:'Kanit',monospace;padding:10px;border:1px solid #ced4da;border-radius:var(--border-radius);box-shadow:inset 0 1px 3px rgba(0,0,0,.06);resize:vertical}
button{padding:8px 15px;font-size:14px;font-weight:600;cursor:pointer;border:none;border-radius:var(--border-radius);transition:all .2s ease-in-out;white-space:nowrap}
#btnProcess{background-color:var(--primary-color);color:white}
#btnProcess:hover{background-color:#0056b3;transform:translateY(-1px);box-shadow:0 3px 6px rgba(0,0,0,.15)}
#btnPDF,#btnSharePDF,.short-out-section .control-group button,#btnPreviewSheet{background-color:var(--secondary-color);color:white}
#btnPDF:hover,#btnSharePDF:hover,.short-out-section .control-group button:hover,#btnPreviewSheet:hover{background-color:#1e7e34;transform:translateY(-1px);box-shadow:0 3px 6px rgba(0,0,0,.15)}
hr{border:0;height:1px;background:#ced4da;margin:20px 0}
#short-out{
    white-space:pre; /* <-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
    background:var(--background-white);
    padding:15px;
    border-radius:var(--border-radius);
    font-size:18px;
    line-height:1.4;
    border:1px solid #dee2e6;
    box-shadow:0 1px 5px rgba(0,0,0,.05);
    overflow-wrap:break-word;
    word-break:break-word;
    margin:10px 0;
    max-width:100%
}

#preview-container{display:flex;flex-direction:column;gap:15px;margin-top:15px}
.page-wrap{width:842px;height:595px;margin:0 auto;background:white;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;box-shadow:0 0 5px rgba(0,0,0,.1);position:relative}
.slot{box-sizing:border-box;padding:15px;display:flex;flex-direction:column;justify-content:space-between;font-weight:600;position:relative}
.line-top{display:flex;justify-content:space-between;font-size:18px;font-weight:700}
.line-top>div:first-child{font-size:24px;font-weight:900}
.passenger{text-align:center;margin-top:15px;margin-bottom:8px;display:block;overflow-wrap:break-word;word-break:break-word;line-height:1.2}
.route{text-align:center;font-size:16px;display:block;overflow-wrap:break-word;word-break:break-word;line-height:1.2;margin:2px 0}
.code{position:absolute;right:15px;bottom:10px;font-size:8px}
</style>
</head>

<body>
<h1> üìÑ ‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô / ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡πÅ‡∏ï‡∏ô‡∏ö‡∏≤‡∏¢ üìã</h1>

<div class="input-section">
    <h2>üì• ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h2>
    <div class="input-control-wrapper">
        <textarea id="input" placeholder="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
        <div class="control-group">
            <button id="btnProcess">‚öôÔ∏è ‡πÅ‡∏õ‡∏•‡∏á & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
        </div>
    </div>
</div>

<hr>

<div class="short-out-section">
    <h2>‚úÖ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ </h2>
    <div class="control-group">
        <button onclick="copyShort()">‚úÇÔ∏è ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠</button>
    </div>
    <div id="short-out">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
</div>

<hr>

<h2>üñ®Ô∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå/‡πÅ‡∏ä‡∏£‡πå </h2>
<div class="control-group">
  <button id="btnPreviewSheet">üëÄ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (PDF)</button>
  <button id="btnPDF">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
  <button id="btnSharePDF">üîó ‡πÅ‡∏ä‡∏£‡πå PDF</button>
</div>

<div id="preview-container"></div>
<script>
// *** ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô WEB_APP_URL ‡πÄ‡∏õ‡πá‡∏ô Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á ***
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz889F8LVJ7RxEIWJTFCHhxi89qriCSQT86m9UgFY5lN_H5UV0LSYrnKvnbhKC_RPmxdA/exec'; 
let PutterName = ""; 
// Map Code (‡∏£‡∏´‡∏±‡∏™‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô)
const LOC_MAP = {
  "S": /‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥|bkk|suvarnabhumi/, "D": /‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á|dmk|don mueang/, "CM": /‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà|chiang mai|cnx/, "PK": /‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï|phuket|hkt/, "PY": /‡∏û‡∏±‡∏ó‡∏¢‡∏≤|‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ|pattaya|chonburi|utp|‡∏ö‡∏≤‡∏á‡∏•‡∏∞‡∏°‡∏∏‡∏á/, "HH": /‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô|cha-am|chaam|huahin/, "KR": /‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà|krabi|kbv/, "SM": /‡∏™‡∏°‡∏∏‡∏¢|surat thani|samui|usm|surat/, "CR": /‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢|chiang rai/, "AY": /‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤|ayutthaya|ayutaya/, "RY": /‡∏£‡∏∞‡∏¢‡∏≠‡∏á|rayong/, 
  // ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏• (Map Code)
  "NB": /‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ|nonthaburi|‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏ô‡∏ó‡πå|‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î|‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á|‡∏ö‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà|‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ß‡∏¢|‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢/, 
  "PT": /‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ|pathum thani|pathumtani|‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤|lam luk ka|‡∏ò‡∏±‡∏ç‡∏ö‡∏∏‡∏£‡∏µ|thanyaburi|‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á|khlong luang|‡∏™‡∏≤‡∏°‡πÇ‡∏Ñ‡∏Å|sam khok|‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏Å‡πâ‡∏ß|lat lum kaew/, 
  "SP": /‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£|samut prakan|‡∏õ‡∏≤‡∏Å‡∏ô‡πâ‡∏≥|‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ|‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á|‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á|‡∏û‡∏£‡∏∞‡∏™‡∏°‡∏∏‡∏ó‡∏£‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå|‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠/, 
  "SS": /‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£|samut sakhon|‡∏°‡∏´‡∏≤‡∏ä‡∏±‡∏¢|‡∏Å‡∏£‡∏∞‡∏ó‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ô|‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏û‡πâ‡∏ß/, 
  "NP": /‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°|nakhon pathom|‡∏™‡∏≤‡∏°‡∏û‡∏£‡∏≤‡∏ô|‡∏ô‡∏Ñ‡∏£‡∏ä‡∏±‡∏¢‡∏®‡∏£‡∏µ|‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ì‡∏ë‡∏•|‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤/,
  // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø (Map Code)
  "BK": /‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û|bangkok|‡∏ö‡∏≤‡∏á‡∏ô‡∏≤|bang na/ 
};
const BANGKOK_AREAS = {
  // ‡πÄ‡∏Ç‡∏ï‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡∏ó‡∏°. ‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£": ["phra nakhon", "‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏•‡∏ß‡∏á", "‡∏ñ‡∏ô‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏£", "‡∏ö‡∏≤‡∏á‡∏•‡∏≥‡∏û‡∏π", "‡∏™‡∏≤‡∏°‡πÄ‡∏™‡∏ô", "samsen", "trok pho", "‡∏ï‡∏£‡∏≠‡∏Å‡πÇ‡∏û‡∏ò‡∏¥‡πå"], 
  "‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å": ["bang rak", "‡∏™‡∏µ‡∏•‡∏°", "‡∏™‡∏≤‡∏ó‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", "bangrak", "‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Å‡∏£‡∏∏‡∏á"],
  "‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô": ["pathum wan", "‡∏™‡∏¢‡∏≤‡∏°", "‡∏ä‡∏¥‡∏î‡∏•‡∏°", "‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏à‡∏¥‡∏ï", "‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ", "‡∏£‡∏≤‡∏ä‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå"],
  "‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö": ["pom prap", "‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä", "‡∏™‡∏≥‡πÄ‡∏û‡πá‡∏á", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏ñ‡∏°", "‡∏ß‡∏±‡∏î‡πÇ‡∏™‡∏°‡∏ô‡∏±‡∏™", "lan luang", "‡∏´‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á"],
  "‡∏ß‡∏±‡∏í‡∏ô‡∏≤": ["watthana", "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó", "‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠", "‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢", "‡∏≠‡πÇ‡∏®‡∏Å"],
  "‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢": ["khlong toei", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 4"], 
  "‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á": ["huai khwang", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9", "‡∏£‡∏±‡∏ä‡∏î‡∏≤", "‡πÄ‡∏´‡∏°‡πà‡∏á‡∏à‡πã‡∏≤‡∏¢"],
  "‡∏û‡∏ç‡∏≤‡πÑ‡∏ó": ["phaya thai", "‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå", "‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤"],
  "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": ["ratchathewi", "‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ô‡πâ‡∏≥"],
  "‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£": ["chatuchak", "‡∏ï‡∏•‡∏≤‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£"],
  // ‡πÄ‡∏Ç‡∏ï ‡∏Å‡∏ó‡∏°. ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  "‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á": ["din daeng"], "‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°": ["bueng kum"], "‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠": ["bang sue"], "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß": ["lat phrao"],
  "‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥": ["bang kapi"], "‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô": ["bang khen"], "‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°": ["bang kho laem"], "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà": ["bangkok yai"],
  "‡∏î‡∏∏‡∏™‡∏¥‡∏ï": ["dusit"], "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î": ["bang phlat"], "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢": ["bangkok noi"], "‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô": ["bang khun thian"], 
  "‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô": ["bang bon"], "‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°": ["nong khaem"], "‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç": ["phasi charoen"], "‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô": ["taling chan"],
  "‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤": ["thawi watthana"], "‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å": ["nong chok"], "‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": ["min buri"], 
  "‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á": ["lat krabang", "‡πÅ‡∏≠‡∏£‡πå‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå"],
  "‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®": ["prawet"], "‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á": ["suan luang", "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£", "‡∏≠‡πà‡∏≠‡∏ô‡∏ô‡∏∏‡∏ä"],
  "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤": ["bang na", "‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç", "‡∏•‡∏≤‡∏ã‡∏≤‡∏•", "‡πÅ‡∏ö‡∏£‡∏¥‡πà‡∏á"],
  "‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á": ["phra khanong"], "‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤": ["yan nawa"], "‡∏™‡∏≤‡∏ó‡∏£": ["sathorn"], 
  "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå": ["samphanthawong"], "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á": ["saphan sung"], "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤": ["khlong sam wa"],
  "‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°": ["sai mai"], "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà": ["lak si"], "‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á": ["chom thong"],
  "‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞": ["rat burana"], "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏": ["thung khru"], "‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á": ["wang thonglang"],
  "‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ": ["bang khae"], 
  // ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏• (5 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
  "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ": ["‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ|nonthaburi", "‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î|pak kret", "‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á|bang bua thong", "‡∏ö‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà|bang yai", "‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ß‡∏¢|bang kruai", "‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢|sai noi"], 
  "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ": ["‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ|pathum thani", "lam luk ka|‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤", "‡∏ò‡∏±‡∏ç‡∏ö‡∏∏‡∏£‡∏µ|thanyaburi", "rangsit|‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á|khlong luang", "‡∏™‡∏≤‡∏°‡πÇ‡∏Ñ‡∏Å|sam khok", "‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏Å‡πâ‡∏ß|lat lum kaew"], 
  "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£": ["‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£|samut prakan", "‡∏õ‡∏≤‡∏Å‡∏ô‡πâ‡∏≥|pak nam", "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ|bang phli", "‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á|bang sao thong", "‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á|phra pradaeng", "‡∏û‡∏£‡∏∞‡∏™‡∏°‡∏∏‡∏ó‡∏£‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå|phra samut chedi", "‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠|bang bo"], 
  "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£": ["‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£|samut sakhon", "‡∏°‡∏´‡∏≤‡∏ä‡∏±‡∏¢|maha chai", "‡∏Å‡∏£‡∏∞‡∏ó‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ô|krathum baen", "‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏û‡πâ‡∏ß|ban phaeo"], 
  "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°": ["‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°|nakhon pathom", "‡∏™‡∏≤‡∏°‡∏û‡∏£‡∏≤‡∏ô|sam phran", "‡∏ô‡∏Ñ‡∏£‡∏ä‡∏±‡∏¢‡∏®‡∏£‡∏µ|nakhon chai si", "‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ì‡∏ë‡∏•|phutthamonthon", "‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤|salaya"],
  
  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡πÄ‡∏®‡∏©
  "‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤": ["‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤|ayutthaya|ayutaya"],
  "‡πÅ‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏ô": ["dmk|don mueang|‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á"],
  "‡πÅ‡∏≠‡∏£‡πå‡∏™‡∏∏": ["bkk|suvarnabhumi|‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥"],
  "‡∏û‡∏±‡∏ó‡∏¢‡∏≤": ["‡∏û‡∏±‡∏ó‡∏¢‡∏≤|pattaya"], "‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô": ["‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô|hua hin"], "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï": ["‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï|phuket"],
  
  "‡∏Å‡∏ó‡∏°.": ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û|bangkok"]
};
// YARN_OVERRIDE ‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç/‡∏à‡∏∏‡∏î‡∏™‡∏ô‡πÉ‡∏à ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
const YARN_OVERRIDE = {
    "‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠": /‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠|thonglor/, "‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢": /‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢|ekkamai/, "‡∏≠‡πÇ‡∏®‡∏Å": /‡∏≠‡πÇ‡∏®‡∏Å|asoke|‡∏ß‡∏±‡∏í‡∏ô‡∏≤|watthana/, 
    "‡∏ô‡∏≤‡∏ô‡∏≤/‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏à‡∏¥‡∏ï": /‡∏ô‡∏≤‡∏ô‡∏≤|nana|‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏à‡∏¥‡∏ï|ploenchit/, "‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ": /‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ|lumphini|‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏/,
    "‡∏™‡∏µ‡∏•‡∏°": /‡∏™‡∏µ‡∏•‡∏°|silom/, "‡∏™‡∏¢‡∏≤‡∏°": /‡∏™‡∏¢‡∏≤‡∏°|siam/, "‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä": /‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä|yaowarat/, 
    "‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ô‡πâ‡∏≥": /‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ô‡πâ‡∏≥|pratunam/, "‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢": /‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå‡∏ä‡∏±‡∏¢|victory/, "‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå": /‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå|aree/, 
    "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏¥‡∏£‡∏¥‡∏Å‡∏¥‡∏ï‡∏¥‡πå": /‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏¥‡∏£‡∏¥‡∏Å‡∏¥‡∏ï‡∏¥‡πå|qsncc/, 
    "‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ô‡∏Ñ‡∏£/‡∏£‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏î‡πå": /‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ô‡∏Ñ‡∏£|charoen nakhon|‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Å‡∏£‡∏∏‡∏á|charoen krung|‡∏£‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏î‡πå|riverside/, 
    "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô": /‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô|khlong san|‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤|chao phraya by uhg|the quarter/, 
    "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9": /‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9|rama 9/, "‡∏õ‡∏¥‡πà‡∏ô‡πÄ‡∏Å‡∏•‡πâ‡∏≤": /‡∏õ‡∏¥‡πà‡∏ô‡πÄ‡∏Å‡∏•‡πâ‡∏≤|pin klao/, "‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤": /‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤|ramintra/, 
    "‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç": /‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç|udomsuk/, "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤": /‡∏ö‡∏≤‡∏á‡∏ô‡∏≤|bang na/, "‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á": /‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á|lat krabang/, "‡∏≠‡∏¥‡∏°‡πÅ‡∏û‡πá‡∏Ñ": /impact|‡∏≠‡∏¥‡∏°‡πÅ‡∏û‡πá‡∏Ñ/ 
};

// --- [ Functions for Logic ] ---
function MAP(t){
  t=t.toLowerCase();
  for(const [code, pattern] of Object.entries(LOC_MAP))
    if(pattern.test(t)) return code.length === 1 ? code : code; 
  return "BK"; 
}
function detectArea(text) {
  if (!text || text.trim() === "") return "‡∏Å‡∏ó‡∏°."; 
  const t = text.toLowerCase();
  for (const [area, keys] of Object.entries(BANGKOK_AREAS)) {
    if (area === "‡∏Å‡∏ó‡∏°.") continue;
    if (keys.some(k => t.includes(k.replace(/[|]/g, '')))) return area;
  }
  return "‡∏Å‡∏ó‡∏°.";
}
function getAreaForShort(text) {
  if (!text || text.trim() === "") return "‡∏Å‡∏ó‡∏°."; 
  const t = text.toLowerCase();
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡∏≠‡∏¢‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó (‡πÄ‡∏î‡∏¥‡∏°)
  const sukhumvitMatch = t.match(/‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó\s*‡∏ã?\s*‡∏≠?\s*‡∏¢?\s*(\d+)/) || t.match(/sukhumvit\s*(soi)?\s*(\d+)/);
  if (sukhumvitMatch) {
    const soiNumber = sukhumvitMatch[2] || sukhumvitMatch[1];
    return "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó" + soiNumber.trim();
  }
  
  // === NEW: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡∏≠‡∏¢‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß ===
  const latphraoMatch = t.match(/‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß\s*‡∏ã?\s*‡∏≠?\s*‡∏¢?\s*(\d+)/) || t.match(/lat phrao\s*(soi)?\s*(\d+)/);
  if (latphraoMatch) {
      const soiNumber = latphraoMatch[2] || latphraoMatch[1];
      return "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß" + soiNumber.trim();
  }
  // ==============================

  if (/dmk|don mueang|‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á/.test(t)) return "‡πÅ‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏ô";
  if (/bkk|suvarnabhumi|‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥/.test(t)) return "‡πÅ‡∏≠‡∏£‡πå‡∏™‡∏∏";
  for(const [yarn, pattern] of Object.entries(YARN_OVERRIDE))
      if(pattern.test(t)) return yarn;
      
  return detectArea(text);
}

function getCode(block){
  const raw=block.match(/„ÄêÊé•È©≥ÁºñÁ†Åcode„Äë(.*)/)||block.match(/code[:Ôºö]?\s*(.*)/i);
  if(!raw) return "";
  return raw[1].trim().match(/[0-9A-Za-z]+/)?.[0]||"";
}
function getAllJobData() {
    const raw = document.getElementById("input").value;
    if (!raw.trim()) return [];
    const blocks = raw.split(/(?=[A-Z]\d{2,5}-\d{1,2})/).filter(x => x.trim());
    const jobData = [];
    blocks.forEach(b => {
        const id = (b.match(/[A-Z]\d{2,5}-\d{1,2}/) || [""])[0];
        const time = (b.match(/„ÄêÊó∂Èó¥‡πÄ‡∏ß‡∏•‡∏≤„Äë(.*)/) || ["", ""])[1].trim();
        const flt = (b.match(/„ÄêËà™Áè≠flight„Äë(.*)/) || ["", ""])[1].trim();
        const pk = (b.match(/„ÄêÊé•‡∏£‡∏±‡∏ö„Äë(.*)/) || ["", ""])[1].trim();
        const dp = (b.match(/„ÄêÈÄÅ‡∏™‡πà‡∏á„Äë(.*)/) || ["", ""])[1].trim();
        const car = (b.match(/„ÄêËΩ¶Âûã‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ñ„Äë(.*)/) || ["", ""])[1].trim();
        const seat = /7\s*SEAT/i.test(car) ? 7 : 5; 
        const A = MAP(pk), B = MAP(dp);
        const areaA = getAreaForShort(pk);
        const areaB = getAreaForShort(dp);
        const date = (b.match(/„ÄêÊó•Êúü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà„Äë(.*)/) || ["", ""])[1].trim();
        jobData.push({date: date, id: id, time: time, seat: seat, mapFrom: A, mapTo: B, areaFrom: areaA, areaTo: areaB, flight: flt, putter: PutterName });
    });
    return jobData;
}
async function sendToGoogleSheet(jobData) {
    if (jobData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ"); return false; }
    const delay = ms => new Promise(res => setTimeout(res, ms));
    const results = [];
    for (const data of jobData) {
        const formData = new FormData();
        formData.append('data', JSON.stringify(data));
        try {
            await fetch(WEB_APP_URL, {
                method: 'POST',
                body: formData,
                mode: 'no-cors' 
            });
            results.push({ status: 'Sent', id: data.id });
            await delay(50); // ‡∏´‡∏ô‡πà‡∏ß‡∏á 50ms ‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô
        } catch (error) {
            console.error('Fetch Error:', error);
            results.push({ status: 'Error', id: data.id, error: error.message });
        }
    }
    const errorCount = results.filter(r => r.status === 'Error').length;
    if (errorCount === 0) { console.log(`Job data for ${jobData.length} jobs sent successfully. (Sent sequentially)`); } 
    else { alert(`‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errorCount} ‡∏á‡∏≤‡∏ô (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Apps Script Logs)`); }
    return true;
}
function parseShort(){
  const raw=document.getElementById("input").value;
  if(!raw.trim()) return "";
  const blocks=raw.split(/(?=[A-Z]\d{2,5}-\d{1,2})/).filter(x=>x.trim());
  let out="";
  let firstDate = "";
  if (blocks.length > 0) {
      const dateMatch = blocks[0].match(/„ÄêÊó•Êúü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà„Äë(.*)/);
      firstDate = dateMatch ? dateMatch[1].trim() : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
  }
  out += firstDate + "\n";
  out += "====================\n";
  const jobData = getAllJobData(); 
  jobData.forEach(job=>{
    out+=`${job.id}//${job.time}//#${job.seat}${job.mapFrom}-${job.mapTo}\n`;
    out+=`${job.areaFrom}‚Äì${job.areaTo}`;
    if(job.flight) out+=` ‚úàÔ∏è${job.flight}`;
    out+=`\n`;
  });
  return out.trim();
}
async function processAndSend() {
    const inputContent = document.getElementById("input").value.trim();
    if (!inputContent) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô"); return; }
    let name = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô(‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ):", PutterName || "");
    if (name === null || name.trim() === "") { alert("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); return; }
    PutterName = name.trim();
    document.getElementById("short-out").textContent = parseShort(); 
    fillPreview();
    const jobData = getAllJobData();
    await sendToGoogleSheet(jobData);
}
function copyShort() {
  const shortEl = document.getElementById("short-out");
  const text = shortEl.innerText || shortEl.textContent;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => { alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úî"); })
    .catch(() => fallbackCopy(text));
  } else { fallbackCopy(text); }
}
function fallbackCopy(text) {
  const textarea = document.createElement("textarea"); textarea.value = text; document.body.appendChild(textarea);
  textarea.select();
  try { document.execCommand("copy"); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úî"); }
  catch(e){ alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå"); }
  document.body.removeChild(textarea);
}

// *** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô shortName ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß ***
function shortName(n){ 
    if(!n) return ""; 
    let cleaned = n.replace(/http:\/\/googleusercontent\.com.*$/, '').trim();
    let textOnly = cleaned.split("(")[0].trim(); 
    
    if (textOnly.length < 5) {
        const addrMatch = cleaned.match(/(\d+\s*.*)/); 
        if (addrMatch) {
            cleaned = addrMatch[1].trim();
        } else {
            cleaned = textOnly;
        }
    } else {
        cleaned = textOnly;
    }
    
    const words = cleaned.match(/[\w‡∏Å-‡πô\u4e00-\u9fff]+/g) || [];
    
    if (/[\u4e00-\u9fff]/.test(cleaned) && words.length === 1) {
        return cleaned.substring(0, 20); 
    }
    
    return words.slice(0, 3).join(" "); 
}
// *** ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á shortName ***

function splitJobs(t){ 
  let b=[],c=[]; 
  for(const l of t.split(/\n/).map(s=>s.trim())){ 
    if(/^[A-Z]\d{2,5}-\d{1,2}/.test(l)){ 
      if(c.length) b.push(c.join("\n")); c=[l]; 
    } else if(l) c.push(l); 
  } 
  if(c.length) b.push(c.join("\n")); 
  return b; 
}
function getVal(t,k){ const m=t.match(new RegExp("„Äê"+k+"„Äë([^\\n]*)")); return m?m[1].trim():""; }

function parseJob(b){ 
  const j=b.match(/^[A-Z]\d{2,5}-\d{1,2}/)?.[0]||""; 
  const date = getVal(b,"Êó•Êúü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
  const time = getVal(b,"Êó∂Èó¥‡πÄ‡∏ß‡∏•‡∏≤");
  const name = getVal(b,"ÂßìÂêç‡∏ä‡∏∑‡πà‡∏≠") || "";
  const pk = getVal(b,"Êé•‡∏£‡∏±‡∏ö");
  const dp = getVal(b,"ÈÄÅ‡∏™‡πà‡∏á");
  
  const route = shortName(pk) + " ‚Üí " + shortName(dp); 
  
  return{jobcode:j,date:date,time:time,name:name,route:route,code:getCode(b)}; 
}
function getJobs(){ const r=document.getElementById("input").value.trim(); return r?splitJobs(r).map(parseJob):[]; }
function adjustFontSize(el,maxFont,minFont){ if(!el) return; let f=maxFont; el.style.fontSize=f+"px"; while((el.scrollWidth>el.clientWidth||el.scrollHeight>el.clientHeight)&&f>minFont){ f--; el.style.fontSize=f+"px"; } }
function makePage(jobs4){
  const w=document.createElement("div"); w.className="page-wrap";
  for(let i=0;i<4;i++){
    const j=jobs4[i]; const s=document.createElement("div"); s.className="slot";
    s.innerHTML=`<div class="line-top"><div>${j?j.jobcode:""}</div><div>${j?j.time:""}</div><div>${j?j.date:""}</div></div><div class="passenger">${j?j.name:""}</div><div class="route">${j?j.route:""}</div><div class="code">${j?j.code:""}</div>`;
    adjustFontSize(s.querySelector(".passenger"), 28, 10); 
    adjustFontSize(s.querySelector(".route"), 18, 8);
    w.appendChild(s);
  }
  return w;
}
function fillPreview(){ 
    const w=document.getElementById("preview-container"); 
    w.innerHTML=""; 
    const j=getJobs(); 
    if(!j.length) return; 
    for(let i=0;i<j.length;i+=4) w.appendChild(makePage(j.slice(i,i+4))); 
}
async function buildPDF(){ const {jsPDF}=window.jspdf; const pages=document.querySelectorAll(".page-wrap"); const pdf=new jsPDF({orientation:"landscape",unit:"pt",format:[842,595]}); for(let i=0;i<pages.length;i++){ const c=await html2canvas(pages[i],{scale:1.5}); pdf.addImage(c.toDataURL('image/jpeg', 0.7), 'JPEG', 0, 0, 842, 595); if(i<pages.length-1) pdf.addPage(); } return pdf; }
function getFileName(){ const r=document.getElementById("input").value.trim(); const m=r.match(/^([A-Z]\d{2,5})-/); return m?m[1]:"JobSheet"; }

document.getElementById("btnProcess").onclick = processAndSend; 
document.getElementById("btnPreviewSheet").onclick=fillPreview;
document.getElementById("btnPDF").onclick=async()=>{ const pdf=await buildPDF(); pdf.save(getFileName()+".pdf"); };
document.getElementById("btnSharePDF").onclick=async()=>{ const pdf=await buildPDF(); const blob=pdf.output("blob"); const file=new File([blob],getFileName()+".pdf",{type:"application/pdf"}); if(navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file],title:"Job Sheet"}); } else { pdf.save(getFileName()+".pdf"); } };
</script>

</body>
</html>

